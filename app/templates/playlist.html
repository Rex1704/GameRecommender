{% extends "base.html" %}
{% block content %}
<div class="content mt-4">
    <div class="d-flex justify-content-between mb-3">
    <form method="POST" action="{{ url_for('playlist.delete', playlist_id=playlist.id) }}">
      <button type="submit" class="btn btn-danger">Delete Playlist</button>
    </form>

    <select name="order_type" id="order-type" class="form-select d-inline w-auto">
      <option value="alpha" {% if order == 'alpha' %} selected {% endif %}>Alphabetical</option>
      <option value="release" {% if order == 'release' %} selected {% endif %}>Release Date</option>
      <option value="playtime" {% if order == 'playtime' %} selected {% endif %}>Time to Complete</option>
      <option value="special" {% if order == 'special' %} selected {% endif %}>Special (Optimized)</option>
      <option value="custom" {% if order == 'custom' %} selected {% endif %}>Custom</option>
    </select>

  </div>

    {% if games %}
        <div class="row">
            {% for game in games %}
            <div class="col-md-3 col-sm-6 mb-4" data-id="{{ game.id }}">
                <div class="card h-100" style="--glow-color-rgb: {{ game.accent_color }};">
                    <a href="{{ url_for('main.game_detail', game_id=game.id) }}" class="text-decoration-none">
                        <img src="{{ game.background_image if game.background_image else ph_url(game.name, 300, 400) }}"
                             class="card-img-top fade-in-img"
                             alt="{{ game.name }}">
                         <div class="card-body">
                            <h6 class="card-title text-dark">{{ game.name }}</h6>
                            <p class="text-muted small mb-0"><b> Genres: </b>{{ game.genres }}</p>
                            <p class="text-muted small mb-0"><b> Rating: </b>{{ game.rating }}</p>
                            <p class="text-muted small mb-0"><b> Released: </b>{{ game.released }}</p>
                          </div>
                    </a>
                    <form action="{{ url_for('playlist.remove_game', playlist_id=playlist.id, game_id=game.id) }}" method="POST" class="position-absolute top-0 end-0 m-2" style="z-index: 10;">
                        <button type="submit" class="btn btn-danger btn-sm">X</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5">
            <p class="text-muted fs-5">This playlist is empty.</p>
            <p>Start by finding a game and adding it to this list!</p>
            <a href="{{ url_for('main.feed') }}" class="btn btn-primary mt-3">Find Games</a>
        </div>
    {% endif %}
</div>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const orderSelect = document.getElementById("order-type");
        orderSelect.addEventListener("change", () => {
            const order = orderSelect.value;
            // Use Flask url_for to generate correct URL
            const url = "{{ url_for('playlist.arrange_playlist', playlist_id=playlist.id) }}?order_type=" + order;
            window.location.href = url;
        });

        const container = document.querySelector(".row");

        // Enable drag only if custom
        const enableDrag = () => {
            if (orderSelect.value === "custom") {
                new Sortable(container, {
                    animation: 150,
                    dataIdAttr: "data-id",
                    onEnd: function (evt) {
                        // Save new order on drag
                        const newOrder = [...container.children].map(el => el.dataset.id);
                        fetch(`/playlist/{{ playlist.id }}/reorder`, {
                            method: "POST",
                            headers: {"Content-Type": "application/json"},
                            body: JSON.stringify({order: newOrder})
                        });
                    }
                });
            }
        }

        enableDrag();


    });
</script>

{% endblock %}