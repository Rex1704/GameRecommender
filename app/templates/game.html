{% extends "base.html" %}
{% block content %}

<div class="game-detail-wrapper">
{% if game.background_image %}
    <div class="position-absolute top-0 start-0 w-100 h-100"
         style="position: fixed;   /* fixed relative to viewport */
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: url('{{ game.background_image }}') center/cover no-repeat;
                filter: blur(9px) brightness(0.3);
                z-index: -1;"></div>
{% endif %}
<div class="content my-4 position-relative">
    <!-- Background image as translucent overlay -->

    <div class="row">
        <div class="col-md-4">
            <!-- Slideshow / Carousel for screenshots -->
<!--            <p>Debug: {{ game.screenshots }}</p>-->
            {% if game.screenshots %}

            <div id="carouselScreenshots" class="carousel slide shadow-lg rounded-3" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for shot in game.screenshots %}
<!--                        <p>Debug {{ shot }}</p>-->
                        <div class="carousel-item {% if loop.first %}active{% endif %}">

                            <img src="{{ shot }}" class="d-block w-100 rounded-3 fade-in-img" alt="Screenshot {{ loop.index }}">
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselScreenshots" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselScreenshots" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
            {% else %}
                <!-- Fallback if no screenshots -->
                <img src="{{ game.background_image if game.background_image else ph_url(game.name, 600, 400) }}"
                     class="img-fluid rounded-3 shadow-lg fade-in-img" alt="{{ game.name }}">
            {% endif %}
        </div>

        <div class="col-md-8 text-white">
            <h1 class="fw-bold display-5">{{ game.name }}</h1>
            <p class="text-light"><strong>Released:</strong> {{ game.released or "N/A" }}</p>
            <p class="text-light"><strong>Genres:</strong> {{ game.genres or "N/A" }}</p>
            <p class="text-light"><strong>Platforms:</strong> {{ game.platforms or "N/A" }}</p>
            <p class="text-light"><strong>Rating:</strong> ⭐ {{ game.rating or "N/A" }} | <strong>Metacritic:</strong> {{ game.metacritic or "N/A" }}</p>

            <div class="mt-4 p-3 rounded" >
                <div class="d-flex flex-wrap align-items-center  gap-3">
                    <form method="post" action="{{ url_for('main.mark_played', game_id=game.id) }}">
                        <button type="submit" class="btn {% if is_played %}btn-success{% else %}btn-outline-primary{% endif %}">
                            {% if is_played %}✓ Played{% else %}Mark as Played{% endif %}
                        </button>
                    </form>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#playlistModal">
                        ➕ Add to To-Play List
                    </button>

                    {% if is_played %}
                        <form action="{{ url_for('main.rate_game', game_id=game.id, rating=0) }}" method="POST" id="rating-form">
                            <div class="star-rating">
                                {% for r in range(5, 0, -1) %}
                                    <input type="radio" id="star{{ r }}" name="rating" value="{{ r }}"
                                           {% if current_rating == r %}checked{% endif %}
                                           onclick="submitRating({{ r }})">
                                    <label for="star{{ r }}" title="{{ r }} stars">★</label>
                                {% endfor %}
                            </div>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h4 class="fw-semibold">Description</h4>
            <p id="game-description" class="text-secondary" style="white-space: pre-line;">
                {{ (game.description or "No description available.") }}
            </p>
            <button id="toggle-desc" class="btn btn-link p-0">Show More</button>
        </div>
    </div>
    <br>
    <h4 class="fw-semibold mb-3">Similar Games</h4>
    <div class="row mt-5">
        {% for rec in recommendations %}
            <div class="col-md-3 col-sm-6 mb-3">
              <a href="{{ url_for('main.game_detail', game_id=rec.id) }}" class="text-decoration-none">
                <div class="card h-100 " style="--glow-color-rgb: {{ rec.accent_color }};">
                  <img src="{{ thumbnail_url(rec.background_image, 600, 400) if rec.background_image else ph_url(rec.name, 300, 400) }}"
                        class="card-img-top" alt="{{ game.name }}" width="300" height="400" loading="lazy">
                  <div class="card-body">
                    <h6 class="card-title text-dark">{{ rec.name }}</h6>
                    <p class="text-muted small mb-0">{{ rec.genres }}</p>
                  </div>
                </div>
              </a>
            </div>
        {% endfor %}
  </div>
</div>

<div class="modal fade" id="playlistModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form method="POST" action="{{ url_for('playlist.add_game', game_id=game.id) }}">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add "{{ game.name }}" to a list</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Select existing lists:</p>
                    {% for pl in current_user.playlists %}
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="playlists" value="{{ pl.id }}" id="pl{{ pl.id }}">
                            <label class="form-check-label" for="pl{{ pl.id }}">{{ pl.name }}</label>
                        </div>
                    {% endfor %}
                    <hr>
                    <label for="newName" class="form-label">Or create a new list:</label>
                    <input class="form-control" type="text" name="new_name" id="newName" placeholder="New playlist name">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </div>
        </form>
    </div>
</div>
</div>
<script>
    function submitRating(rating) {
        const form = document.getElementById("rating-form");
        form.action = "{{ url_for('main.rate_game', game_id=game.id, rating=0) }}".replace("/0", "/" + rating);
        form.submit();
    }
    // Show More/Less Script
    document.addEventListener("DOMContentLoaded", function() {
        const desc = document.getElementById("game-description");
        const btn = document.getElementById("toggle-desc");
        if (!desc || !btn) return;

        if (desc.innerText.length > 400) {
            const fullText = desc.innerText;
            const shortText = fullText.substring(0, 400) + "...";
            let isExpanded = false;
            desc.innerText = shortText;

            btn.style.display = "inline-block";
            btn.addEventListener("click", () => {
                isExpanded = !isExpanded;
                desc.innerText = isExpanded ? fullText : shortText;
                btn.innerText = isExpanded ? "Show Less" : "Show More";
            });
        } else {
            btn.style.display = "none";
        }
    });
</script>
{% endblock %}